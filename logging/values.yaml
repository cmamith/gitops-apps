# # Namespace + IRSA binding
# serviceAccount:
#   create: true
#   name: fluent-bit
#   annotations:
#     eks.amazonaws.com/role-arn: arn:aws:iam::177206615793:role/eks-fluentbit-cloudwatch

# namespaceOverride: logging

# daemonSet:
#   enabled: true   # run on every node

# # Tail all container logs
# input:
#   tail:
#     enabled: true
#     path: /var/log/containers/*.log
#     parser: docker
#     memBufLimit: 10MB
#     skipLongLines: On
#     refreshInterval: 5
#     readFromHead: Off

# # Add Kubernetes metadata (namespace, pod, labels)
# filters:
#   kubernetes:
#     enabled: true
#     match: "*"
#     kubeURL: https://kubernetes.default.svc
#     mergeLog: On
#     keepLog: Off

# # Ship to CloudWatch Logs (ap-southeast-1)
# cloudWatch:
#   enabled: true
#   region: ap-southeast-1
#   # group by namespace/app for easy per-service views
#   logGroupName: /eks/3tier/${kubernetes['namespace']}/${kubernetes['labels']['app.kubernetes.io/name']}-${kubernetes['container_name']}
#   logStreamPrefix: ${kubernetes['pod_name']}/
#   autoCreateGroup: true
#   logRetentionDays: 14

# resources:
#   requests: { cpu: 50m,  memory: 128Mi }
#   limits:   { cpu: 200m, memory: 256Mi }


# nodeSelector:
#   eks.amazonaws.com/compute-type: ec2

serviceAccount:
  create: true
  name: fluent-bit
  annotations:
    # your IRSA role ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::177206615793:role/eks-fluentbit-cloudwatch

namespaceOverride: logging

daemonSet:
  enabled: true

input:
  tail:
    enabled: true
    path: /var/log/containers/*.log
    parser: docker

filters:
  kubernetes:
    enabled: true
    match: "*"
    kubeURL: https://kubernetes.default.svc

sources:
  - repoURL: https://aws.github.io/eks-charts
    chart: aws-for-fluent-bit
    targetRevision: "0.1.28"
    helm:
      valueFiles:
        - "$values/logging/values.yaml"
  - repoURL: https://github.com/cmamith/gitops-apps
    targetRevision: main
    ref: values

# Disable old CloudWatch output block
cloudWatch:
  enabled: false

# Use CloudWatch Logs with per-service group naming
cloudWatchLogs:
  enabled: true
  region: ap-southeast-1
  logGroupName: ""   # keep empty so template is used
  # âœ… correct variable syntax (no curly braces)
  logGroupTemplate: "/eks/3tier/$kubernetes['namespace_name']/$kubernetes['labels']['svc']-$kubernetes['container_name']"
  logStreamTemplate: "$kubernetes['pod_name'].$kubernetes['container_name']"
  autoCreateGroup: true
  logRetentionDays: 14

resources:
  requests: { cpu: 25m, memory: 96Mi }
  limits:   { cpu: 150m, memory: 192Mi }

tolerations:
  - operator: Exists
